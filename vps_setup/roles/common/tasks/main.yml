---
#========================================================
# roles/common - パッケージ更新・基本パッケージ導入
# setup2.sh STEP1〜2・8・11 相当
# ※ STEP8（Git）と STEP11（unattended-upgrades）は
#   Ansible では前提パッケージとして STEP2 相当でまとめてインストール
#========================================================

# ── apt ロック対策（Ubuntu 24.04 定期タイマーとの競合防止） ─────
# Ubuntu 24.04 は systemd タイマーにより apt-daily / apt-daily-upgrade が
# 毎日ランダムな時間帯に自動実行される（起動直後に限らない）。
# このプロセスが dpkg ロックを取得したまま動いていると
# apt-get が "Could not get lock" で失敗する。
# setup2.sh の wait_for_apt_lock() と同等の処理。
#
# ★ raw モジュールを使う理由:
#   ansible.builtin.systemd（loop）や shell を使うと
#   タスクごとに SFTP/SCP で Python モジュールを転送する必要がある。
#   apt-daily-upgrade 実行中はメモリを大量消費（～1.4GB）しており
#   SFTP/SCP サブシステムの起動に必要なメモリが枯渇して両方失敗し
#   UNREACHABLE になる。
#   raw モジュールは Python 転送不要・SSH で直接実行するため回避できる。

- name: apt 自動更新サービスを停止してロック解放を待機
  ansible.builtin.raw: |
    # 3サービスを1コマンドで一括停止（順番にループしない）
    systemctl stop unattended-upgrades apt-daily apt-daily-upgrade 2>/dev/null || true
    # dpkg ロック解放待機（最大 180 秒）
    i=0
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/dpkg/lock          >/dev/null 2>&1 || \
          fuser /var/lib/apt/lists/lock     >/dev/null 2>&1; do
      [ $i -ge 36 ] && echo "apt ロック待機タイムアウト（180秒）" && exit 1
      echo "apt ロック待機中... $((i*5))秒"
      sleep 5
      i=$((i+1))
    done
    echo "apt ロック解放済み"
  changed_when: false

# ── STEP 1: パッケージ更新 ───────────────────────────────────────

- name: apt キャッシュを更新
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 0

- name: 全パッケージをアップグレード
  # setup2.sh は apt-get upgrade（通常アップグレード）を使用
  # dist-upgrade ではなく upgrade: yes で合わせる
  ansible.builtin.apt:
    upgrade: yes
    autoremove: yes
    autoclean: yes

# ── STEP 2: 前提パッケージ導入 ───────────────────────────────────

- name: 前提パッケージをインストール
  ansible.builtin.apt:
    name:
      - ca-certificates           # SSL証明書
      - curl                      # HTTPクライアント
      - gnupg                     # GPG暗号化（Docker GPGキー取得に使用）
      - lsb-release               # ディストリビューション情報
      - software-properties-common # リポジトリ管理
      - git                       # バージョン管理（setup2.sh STEP8相当）
      - unattended-upgrades       # セキュリティ自動更新（setup2.sh STEP11相当）
    state: present

# ── STEP 11: セキュリティ自動更新の有効化 ────────────────────────

- name: セキュリティ自動更新の設定ファイルを配置
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
    owner: root
    group: root
    mode: '0644'
