---
#========================================================
# roles/common - パッケージ更新・基本パッケージ導入
# setup2.sh STEP1〜2・11 相当
#========================================================

# ── apt ロック対策（Ubuntu 24.04 起動直後の競合防止） ────────────
# Ubuntu 24.04 はOS起動直後に unattended-upgrades が自動実行される。
# このプロセスが dpkg ロックを取得したまま動いていると
# apt-get が "Could not get lock" で失敗する。
# setup2.sh の wait_for_apt_lock() と同等の処理。

- name: apt 自動更新サービスを一時停止（ロック競合防止）
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
  loop:
    - unattended-upgrades
    - apt-daily
    - apt-daily-upgrade
  failed_when: false  # サービスが存在しない場合もあるため

- name: apt ロック解放待機（最大 180 秒）
  ansible.builtin.shell: |
    i=0
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/dpkg/lock          >/dev/null 2>&1 || \
          fuser /var/lib/apt/lists/lock     >/dev/null 2>&1; do
      [ $i -ge 36 ] && echo "apt ロック待機タイムアウト（180秒）" && exit 1
      echo "apt ロック待機中... $((i*5))秒"
      sleep 5
      i=$((i+1))
    done
    echo "apt ロック解放済み"
  changed_when: false

# ── STEP 1: パッケージ更新 ───────────────────────────────────────

- name: apt キャッシュを更新
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 0

- name: 全パッケージをアップグレード
  # setup2.sh は apt-get upgrade（通常アップグレード）を使用
  # dist-upgrade ではなく upgrade: yes で合わせる
  ansible.builtin.apt:
    upgrade: yes
    autoremove: yes
    autoclean: yes

# ── STEP 2: 前提パッケージ導入 ───────────────────────────────────

- name: 前提パッケージをインストール
  ansible.builtin.apt:
    name:
      - ca-certificates           # SSL証明書
      - curl                      # HTTPクライアント
      - gnupg                     # GPG暗号化（Docker GPGキー取得に使用）
      - lsb-release               # ディストリビューション情報
      - software-properties-common # リポジトリ管理
      - git                       # バージョン管理（setup2.sh STEP8相当）
      - unattended-upgrades       # セキュリティ自動更新（setup2.sh STEP11相当）
    state: present

# ── STEP 11: セキュリティ自動更新の有効化 ────────────────────────

- name: セキュリティ自動更新の設定ファイルを配置
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
    owner: root
    group: root
    mode: '0644'
